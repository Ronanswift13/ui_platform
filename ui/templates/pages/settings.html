{% extends "base.html" %}

{% block title %}系统设置 - 输变电监测平台{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-3">
        <!-- 设置导航 -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-gear"></i> 设置</h5>
            </div>
            <div class="list-group list-group-flush">
                <a href="#general" class="list-group-item list-group-item-action active" data-bs-toggle="list">
                    <i class="bi bi-sliders"></i> 通用设置
                </a>
                <a href="#plugins" class="list-group-item list-group-item-action" data-bs-toggle="list">
                    <i class="bi bi-puzzle"></i> 插件管理
                </a>
                <a href="#devices" class="list-group-item list-group-item-action" data-bs-toggle="list">
                    <i class="bi bi-camera-video"></i> 设备管理
                </a>
                <a href="#sites" class="list-group-item list-group-item-action" data-bs-toggle="list">
                    <i class="bi bi-geo-alt"></i> 站点管理
                </a>
                <a href="#logs" class="list-group-item list-group-item-action" data-bs-toggle="list">
                    <i class="bi bi-journal-text"></i> 日志查看
                </a>
                <a href="#about" class="list-group-item list-group-item-action" data-bs-toggle="list">
                    <i class="bi bi-info-circle"></i> 关于
                </a>
            </div>
        </div>
    </div>

    <div class="col-lg-9">
        <div class="tab-content">
            <!-- 通用设置 -->
            <div class="tab-pane fade show active" id="general">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">通用设置</h5>
                    </div>
                    <div class="card-body">
                        <form>
                            <div class="mb-3">
                                <label class="form-label">平台名称</label>
                                <input type="text" class="form-control" value="输变电激光星芒监测平台">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">日志级别</label>
                                <select class="form-select">
                                    <option value="DEBUG">DEBUG</option>
                                    <option value="INFO" selected>INFO</option>
                                    <option value="WARNING">WARNING</option>
                                    <option value="ERROR">ERROR</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">任务超时 (秒)</label>
                                <input type="number" class="form-control" value="300">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">最大并发任务</label>
                                <input type="number" class="form-control" value="4">
                            </div>
                            <button type="submit" class="btn btn-primary">保存设置</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- 插件管理 -->
            <div class="tab-pane fade" id="plugins">
                <div class="card mb-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">插件管理</h5>
                        <div>
                            <button class="btn btn-sm btn-outline-primary" id="btn-scan-plugins">
                                <i class="bi bi-arrow-repeat"></i> 扫描
                            </button>
                            <button class="btn btn-sm btn-success" id="btn-load-all">
                                <i class="bi bi-play"></i> 全部加载
                            </button>
                            <button class="btn btn-sm btn-info" id="btn-health-all">
                                <i class="bi bi-heart-pulse"></i> 健康检查
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>插件ID</th>
                                    <th>名称</th>
                                    <th>版本</th>
                                    <th>状态</th>
                                    <th>能力</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="plugin-table">
                                <tr><td colspan="6" class="text-center text-muted">加载中...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <!-- 健康状态卡片 -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-heart-pulse"></i> 插件健康状态</h5>
                    </div>
                    <div class="card-body">
                        <div class="row" id="health-cards">
                            <div class="col-12 text-center text-muted py-3">
                                点击"健康检查"按钮查看各插件健康状态
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 设备管理 -->
            <div class="tab-pane fade" id="devices">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">设备管理</h5>
                        <button class="btn btn-sm btn-primary">
                            <i class="bi bi-plus"></i> 添加设备
                        </button>
                    </div>
                    <div class="card-body">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>设备ID</th>
                                    <th>类型</th>
                                    <th>名称</th>
                                    <th>状态</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="device-table">
                                <!-- 动态加载 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 站点管理 -->
            <div class="tab-pane fade" id="sites">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">站点管理</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted">站点配置功能开发中...</p>
                    </div>
                </div>
            </div>

            <!-- 日志查看 -->
            <div class="tab-pane fade" id="logs">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">日志查看</h5>
                        <div>
                            <select class="form-select form-select-sm d-inline-block w-auto">
                                <option value="platform">平台日志</option>
                                <option value="errors">错误日志</option>
                            </select>
                            <button class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-arrow-repeat"></i> 刷新
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <pre class="bg-dark text-light p-3" style="max-height: 500px; overflow-y: auto;" id="log-content">
正在加载日志...
                        </pre>
                    </div>
                </div>
            </div>

            <!-- 关于 -->
            <div class="tab-pane fade" id="about">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">关于</h5>
                    </div>
                    <div class="card-body text-center">
                        <h2 class="text-primary"><i class="bi bi-lightning-charge"></i></h2>
                        <h3>输变电激光星芒破夜绘明监测平台</h3>
                        <p class="text-muted">版本 1.0.0</p>
                        <hr>
                        <p>高智能化输变电站自主巡视与监测系统</p>
                        <p class="small text-muted">
                            支持主变巡视、开关间隔、母线巡视、电容器检测、表计读数等功能模块
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 页面初始化
document.addEventListener('DOMContentLoaded', function() {
    loadPlugins();
    loadDevices();

    // 绑定按钮事件
    document.getElementById('btn-scan-plugins').addEventListener('click', loadPlugins);
    document.getElementById('btn-load-all').addEventListener('click', loadAllPlugins);
    document.getElementById('btn-health-all').addEventListener('click', checkAllHealth);
});

// 加载插件列表
async function loadPlugins() {
    try {
        const plugins = await API.getPlugins();
        renderPluginTable(plugins);
        updatePluginCount(plugins.length);
    } catch (error) {
        console.error('加载插件失败:', error);
    }
}

// 渲染插件表格
function renderPluginTable(plugins) {
    const table = document.getElementById('plugin-table');
    if (!plugins || plugins.length === 0) {
        table.innerHTML = '<tr><td colspan="6" class="text-center text-muted">暂无插件</td></tr>';
        return;
    }

    table.innerHTML = plugins.map(p => {
        const statusClass = {
            'ready': 'success', 'running': 'primary', 'loading': 'info',
            'error': 'danger', 'disabled': 'secondary'
        }[p.status] || 'warning';

        const caps = p.capabilities.map(c =>
            '<span class="badge bg-info me-1">' + c + '</span>'
        ).join('');

        return '<tr>' +
            '<td><code>' + p.id + '</code></td>' +
            '<td>' + p.name + '</td>' +
            '<td><span class="badge bg-secondary">' + p.version + '</span></td>' +
            '<td><span class="badge bg-' + statusClass + '">' + p.status + '</span></td>' +
            '<td>' + caps + '</td>' +
            '<td>' +
                '<div class="btn-group btn-group-sm">' +
                    '<button class="btn btn-outline-success" onclick="loadPlugin(\'' + p.id + '\')" title="加载"><i class="bi bi-play"></i></button>' +
                    '<button class="btn btn-outline-primary" onclick="reloadPlugin(\'' + p.id + '\')" title="重载"><i class="bi bi-arrow-repeat"></i></button>' +
                    '<button class="btn btn-outline-info" onclick="checkPluginHealth(\'' + p.id + '\')" title="健康检查"><i class="bi bi-heart-pulse"></i></button>' +
                '</div>' +
            '</td>' +
        '</tr>';
    }).join('');
}

// 加载单个插件
async function loadPlugin(id) {
    try {
        await API.post('/plugins/' + id + '/load');
        showToast('插件 ' + id + ' 加载成功', 'success');
        loadPlugins();
    } catch (error) {
        showToast('加载失败: ' + error.message, 'danger');
    }
}

// 重载插件
async function reloadPlugin(id) {
    try {
        await API.reloadPlugin(id);
        showToast('插件 ' + id + ' 重载成功', 'success');
        loadPlugins();
    } catch (error) {
        showToast('重载失败: ' + error.message, 'danger');
    }
}

// 加载所有插件
async function loadAllPlugins() {
    try {
        const plugins = await API.getPlugins();
        for (const p of plugins) {
            try {
                await API.post('/plugins/' + p.id + '/load');
            } catch (e) { console.warn('加载 ' + p.id + ' 失败:', e); }
        }
        showToast('所有插件加载完成', 'success');
        loadPlugins();
    } catch (error) {
        showToast('批量加载失败: ' + error.message, 'danger');
    }
}

// 检查单个插件健康
async function checkPluginHealth(id) {
    try {
        const health = await API.get('/plugins/' + id + '/health');
        showToast(id + ': ' + (health.healthy ? '健康' : '异常') + ' - ' + health.message,
                  health.healthy ? 'success' : 'warning');
    } catch (error) {
        showToast('健康检查失败: ' + error.message, 'danger');
    }
}

// 检查所有插件健康
async function checkAllHealth() {
    try {
        const results = await API.get('/plugins/health');
        const container = document.getElementById('health-cards');

        let html = '';
        for (const [id, status] of Object.entries(results)) {
            const icon = status.healthy ? 'bi-check-circle-fill text-success' : 'bi-x-circle-fill text-danger';
            const border = status.healthy ? 'border-success' : 'border-danger';
            html += '<div class="col-md-6 col-lg-4 mb-3">' +
                '<div class="card ' + border + '">' +
                    '<div class="card-body p-2">' +
                        '<div class="d-flex align-items-center">' +
                            '<i class="bi ' + icon + ' me-2" style="font-size: 1.5rem;"></i>' +
                            '<div><strong>' + id + '</strong><br><small class="text-muted">' + status.message + '</small></div>' +
                        '</div>' +
                    '</div>' +
                '</div>' +
            '</div>';
        }
        container.innerHTML = html;
        showToast('健康检查完成', 'success');
    } catch (error) {
        showToast('健康检查失败: ' + error.message, 'danger');
    }
}

// 加载设备列表
async function loadDevices() {
    try {
        const devices = await API.get('/devices');
        renderDeviceTable(devices);
    } catch (error) {
        console.error('加载设备失败:', error);
    }
}

function renderDeviceTable(devices) {
    const table = document.getElementById('device-table');
    if (!devices || devices.length === 0) {
        table.innerHTML = '<tr><td colspan="5" class="text-center text-muted">暂无设备</td></tr>';
        return;
    }

    table.innerHTML = devices.map(d => {
        const statusClass = d.is_connected ? 'success' : 'secondary';
        return '<tr>' +
            '<td><code>' + d.id + '</code></td>' +
            '<td>' + d.type + '</td>' +
            '<td>' + d.name + '</td>' +
            '<td><span class="badge bg-' + statusClass + '">' + (d.is_connected ? '已连接' : '未连接') + '</span></td>' +
            '<td>' +
                '<button class="btn btn-sm btn-outline-primary" onclick="toggleDevice(\'' + d.id + '\', ' + d.is_connected + ')">' +
                    (d.is_connected ? '<i class="bi bi-stop"></i>' : '<i class="bi bi-play"></i>') +
                '</button>' +
            '</td>' +
        '</tr>';
    }).join('');
}

async function toggleDevice(id, connected) {
    try {
        const action = connected ? 'disconnect' : 'connect';
        await API.post('/devices/' + id + '/' + action);
        showToast('设备' + (connected ? '已断开' : '已连接'), 'success');
        loadDevices();
    } catch (error) {
        showToast('操作失败: ' + error.message, 'danger');
    }
}
</script>
{% endblock %}
