{% extends "base.html" %}

{% block title %}{{ module_name }} - 输变电监测平台{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- 模块标题 -->
        <div class="card mb-3">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h3><i class="bi bi-{{ module_icon }}"></i> {{ module_name }}</h3>
                        <p class="text-muted mb-0">{{ module_description }}</p>
                    </div>
                    <div>
                        <span class="badge bg-{{ 'success' if plugin_status == 'ready' else 'warning' }} fs-6">
                            {% if plugin_status == 'ready' %}
                                <i class="bi bi-check-circle"></i> 插件已就绪
                            {% elif plugin_status == 'placeholder' %}
                                <i class="bi bi-hourglass"></i> 待集成
                            {% else %}
                                <i class="bi bi-exclamation-circle"></i> 未加载
                            {% endif %}
                        </span>
                    </div>
                </div>
            </div>
        </div>

        {% if plugin_status == 'placeholder' %}
        <!-- 占位提示 -->
        <div class="card">
            <div class="card-body text-center py-5">
                <i class="bi bi-puzzle text-primary" style="font-size: 4rem;"></i>
                <h4 class="mt-3">功能模块待集成</h4>
                <p class="text-muted">该功能模块的算法插件尚未接入,请按照以下接口要求提交:</p>

                <div class="row justify-content-center mt-4">
                    <div class="col-lg-8">
                        <div class="card bg-light">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="bi bi-code-square"></i> 插件接口要求</h5>
                            </div>
                            <div class="card-body text-start">
                                <h6>1. 目录结构</h6>
                                <pre class="bg-dark text-light p-3 rounded"><code>plugins/{{ module_id }}/
├── manifest.json      # 插件清单
├── plugin.py          # 入口文件
├── models/            # 模型文件
├── configs/           # 配置文件
│   └── default.yaml
├── tests/             # 测试用例
│   └── test_plugin.py
└── README.md          # 说明文档</code></pre>

                                <h6>2. 必须实现的接口</h6>
                                <pre class="bg-dark text-light p-3 rounded"><code>class Plugin(BasePlugin):
    def init(self, config: dict) -> bool:
        """初始化插件"""
        pass

    def infer(self, frame: np.ndarray, rois: list[ROI], context: PluginContext) -> list[RecognitionResult]:
        """执行推理"""
        pass

    def postprocess(self, results: list[RecognitionResult], rules: list[AlarmRule]) -> list[Alarm]:
        """后处理和告警生成"""
        pass

    def healthcheck(self) -> HealthStatus:
        """健康检查"""
        pass</code></pre>

                                <h6>3. 输出格式要求</h6>
                                <pre class="bg-dark text-light p-3 rounded"><code>{
    "task_id": "xxx",
    "plugin_id": "{{ module_id }}",
    "plugin_version": "1.0.0",
    "code_hash": "abc123",
    "success": true,
    "results": [
        {
            "roi_id": "xxx",
            "bbox": {"x": 0.1, "y": 0.2, "width": 0.3, "height": 0.4},
            "label": "正常/异常",
            "value": null,
            "confidence": 0.95,
            "model_version": "v1.0",
            "timestamp": "2024-01-01T12:00:00"
        }
    ],
    "alarms": []
}</code></pre>

                                <h6>4. 交付清单</h6>
                                <ul>
                                    <li>完整代码包 (含requirements.txt)</li>
                                    <li>回放测试数据 (至少20段视频或200张图)</li>
                                    <li>模型文件 (如有)</li>
                                    <li>配置样例</li>
                                    <li>README文档</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-4">
                    <a href="/docs/plugins/{{ module_id }}" class="btn btn-primary">
                        <i class="bi bi-book"></i> 查看完整文档
                    </a>
                    <a href="/api/plugins/{{ module_id }}/template" class="btn btn-outline-primary">
                        <i class="bi bi-download"></i> 下载模板
                    </a>
                </div>
            </div>
        </div>
        {% else %}
        <!-- 正常功能界面 (与首页类似的四区布局) -->
        <div class="row">
            <!-- 左侧预览区 -->
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-camera-video"></i> 预览</h5>
                    </div>
                    <div class="card-body">
                        <div class="video-container" style="min-height: 400px; background: #1a1a1a;">
                            <canvas id="video-canvas" class="w-100"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 右侧控制区 -->
            <div class="col-lg-4">
                <!-- 与首页相同的控制面板 -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">控制面板</h5>
                    </div>
                    <div class="card-body">
                        <p>功能控制区域</p>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
