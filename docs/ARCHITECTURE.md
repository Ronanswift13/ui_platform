# 输变电激光星芒破夜绘明监测平台 - 架构文档

## 1. 项目工作树

```
破夜绘明激光监测平台/
│
├── apps/                           # 应用入口层 (只做参数解析与装配)
│   ├── __init__.py
│   ├── main.py                     # 主程序入口 (UI + API)
│   ├── api_server.py               # REST API 服务器
│   └── ui_server.py                # Web UI 服务器
│
├── platform_core/                  # 平台核心层
│   ├── __init__.py                 # 核心模块导出
│   ├── config.py                   # 配置中心
│   ├── exceptions.py               # 统一异常定义
│   │
│   ├── schema/                     # 统一Schema校验
│   │   ├── __init__.py
│   │   ├── models.py               # 数据模型 (Site/Device/ROI/Task/Result)
│   │   └── validator.py            # 校验器
│   │
│   ├── plugin_manager/             # 插件管理器
│   │   ├── __init__.py
│   │   ├── base.py                 # 插件基类 (BasePlugin)
│   │   ├── manager.py              # 插件管理器
│   │   └── registry.py             # 插件注册表
│   │
│   ├── scheduler/                  # 任务调度
│   │   ├── __init__.py
│   │   ├── engine.py               # 任务引擎
│   │   ├── executor.py             # 任务执行器
│   │   └── queue.py                # 任务队列
│   │
│   ├── evidence/                   # 证据链管理
│   │   ├── __init__.py
│   │   ├── manager.py              # 证据管理器
│   │   └── storage.py              # 存储后端
│   │
│   ├── replay/                     # 回放功能
│   │   ├── __init__.py
│   │   ├── player.py               # 回放播放器
│   │   └── recorder.py             # 回放录制器
│   │
│   ├── device_adapter/             # 设备适配层
│   │   ├── __init__.py
│   │   ├── base.py                 # 设备基类
│   │   ├── camera.py               # 摄像头适配
│   │   ├── ptz.py                  # 云台适配
│   │   └── manager.py              # 设备管理器
│   │
│   └── logging/                    # 统一日志
│       └── __init__.py             # 日志配置
│
├── plugins/                        # 插件目录 (五大业务模块)
│   │
│   ├── transformer_inspection/     # A组: 主变自主巡视
│   │   ├── manifest.json           # 插件清单
│   │   ├── plugin.py               # 插件入口
│   │   ├── README.md               # 说明文档
│   │   ├── models/                 # 模型文件
│   │   ├── configs/                # 配置文件
│   │   │   └── default.yaml
│   │   └── tests/                  # 测试用例
│   │
│   ├── switch_inspection/          # B组: 开关间隔巡视
│   │   ├── manifest.json
│   │   ├── plugin.py
│   │   └── ...
│   │
│   ├── busbar_inspection/          # C组: 母线巡视
│   │   ├── manifest.json
│   │   ├── plugin.py
│   │   └── ...
│   │
│   ├── capacitor_inspection/       # D组: 电容器巡视
│   │   ├── manifest.json
│   │   ├── plugin.py
│   │   └── ...
│   │
│   └── meter_reading/              # E组: 表计读数
│       ├── manifest.json
│       ├── plugin.py
│       └── ...
│
├── configs/                        # 配置文件
│   ├── platform.yaml               # 平台主配置
│   ├── sites/                      # 站点配置
│   │   └── example_site.yaml
│   ├── devices/                    # 设备配置
│   ├── rules/                      # 告警规则
│   └── tasks/                      # 任务模板
│
├── ui/                             # Web UI
│   ├── __init__.py
│   ├── templates/                  # Jinja2模板
│   │   ├── base.html               # 基础模板
│   │   ├── index.html              # 首页
│   │   └── pages/                  # 页面模板
│   │       ├── module.html         # 功能模块页
│   │       └── settings.html       # 设置页
│   └── static/                     # 静态资源
│       ├── css/
│       │   └── main.css
│       ├── js/
│       │   └── main.js
│       └── images/
│
├── evidence/                       # 证据存储
│   ├── runs/                       # 运行记录
│   │   └── {run_id}/
│   │       ├── raw/                # 原始图像
│   │       ├── annotated/          # 标注图像
│   │       ├── results/            # 识别结果
│   │       └── meta.json           # 元数据
│   └── exports/                    # 导出文件
│
├── logs/                           # 日志目录
│   ├── platform.log                # 主日志
│   └── errors.log                  # 错误日志
│
├── tests/                          # 测试
│   ├── unit/                       # 单元测试
│   ├── integration/                # 集成测试
│   └── replay_data/                # 回放测试数据
│
├── docs/                           # 文档
│   ├── ARCHITECTURE.md             # 架构文档
│   ├── api/                        # API文档
│   ├── plugins/                    # 插件开发文档
│   └── architecture/               # 架构图
│
├── scripts/                        # 脚本
│   ├── install.sh                  # Linux/Mac安装
│   └── install.bat                 # Windows安装
│
├── run.py                          # 快速启动脚本
├── build.py                        # 打包脚本
├── pyproject.toml                  # 项目配置
├── requirements.txt                # 依赖列表
└── README.md                       # 项目说明
```

## 2. 分层架构图

```
┌─────────────────────────────────────────────────────────────────────┐
│                           UI 层                                     │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐   │
│  │   主变巡视   │ │  开关间隔   │ │   母线巡视   │ │   表计读数   │   │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘   │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  任务区 │ ROI区 │ 运行区 │ 结果区 │ 告警面板 │ 证据回放      │   │
│  └─────────────────────────────────────────────────────────────┘   │
├─────────────────────────────────────────────────────────────────────┤
│                          API 层                                     │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐              │
│  │ 任务API  │ │ 插件API  │ │ 证据API  │ │ 设备API  │              │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘              │
├─────────────────────────────────────────────────────────────────────┤
│                         任务层                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                      任务引擎 (TaskEngine)                    │  │
│  │  站点 → 点位 → 设备 → 部件 → 任务 → 插件 → ROI → 规则 → 结果  │  │
│  └──────────────────────────────────────────────────────────────┘  │
│  ┌───────────────┐ ┌───────────────┐ ┌───────────────┐            │
│  │   任务队列     │ │   任务执行器   │ │   回放播放器   │            │
│  └───────────────┘ └───────────────┘ └───────────────┘            │
├─────────────────────────────────────────────────────────────────────┤
│                         算法层 (插件)                               │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ │
│  │  A组     │ │  B组     │ │  C组     │ │  D组     │ │  E组     │ │
│  │ 主变巡视 │ │ 开关间隔 │ │ 母线巡视 │ │ 电容器   │ │ 表计读数 │ │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘ └──────────┘ │
│                    ↑ 统一插件接口 (BasePlugin) ↑                   │
├─────────────────────────────────────────────────────────────────────┤
│                       设备适配层                                    │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐              │
│  │  摄像头   │ │   云台    │ │  热成像   │ │ (LiDAR)  │              │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘              │
├─────────────────────────────────────────────────────────────────────┤
│                         数据层                                      │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐              │
│  │ 配置库   │ │ 结果库   │ │ 证据库   │ │ 日志库   │              │
│  │ YAML/JSON│ │ JSON     │ │ 文件系统  │ │ 文件     │              │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘              │
└─────────────────────────────────────────────────────────────────────┘
```

## 3. 数据流图

```
                                    ┌─────────────┐
                                    │   摄像头    │
                                    └──────┬──────┘
                                           │ 视频流/图像
                                           ▼
┌─────────────┐    触发任务    ┌──────────────────┐
│    UI/API   │ ────────────► │    任务引擎      │
└─────────────┘               └────────┬─────────┘
                                       │
                    ┌──────────────────┼──────────────────┐
                    ▼                  ▼                  ▼
            ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
            │  加载ROI    │    │  加载规则   │    │  选择插件   │
            └──────┬──────┘    └──────┬──────┘    └──────┬──────┘
                   │                  │                  │
                   └──────────────────┼──────────────────┘
                                      ▼
                              ┌─────────────┐
                              │  执行推理   │
                              │  (插件)     │
                              └──────┬──────┘
                                     │
                    ┌────────────────┼────────────────┐
                    ▼                ▼                ▼
            ┌─────────────┐  ┌─────────────┐  ┌─────────────┐
            │  保存证据   │  │  应用规则   │  │  输出结果   │
            │  (原图+标注) │  │  (生成告警) │  │  (JSON)     │
            └──────┬──────┘  └──────┬──────┘  └──────┬──────┘
                   │                │                │
                   └────────────────┼────────────────┘
                                    ▼
                            ┌─────────────┐
                            │  返回UI/API │
                            └─────────────┘
```

## 4. 插件接口规范

### 4.1 必须实现的接口

```python
class BasePlugin(ABC):

    @abstractmethod
    def init(self, config: dict) -> bool:
        """初始化插件"""
        pass

    @abstractmethod
    def infer(self, frame: np.ndarray, rois: list[ROI], context: PluginContext) -> list[RecognitionResult]:
        """执行推理"""
        pass

    @abstractmethod
    def postprocess(self, results: list[RecognitionResult], rules: list[AlarmRule]) -> list[Alarm]:
        """后处理和告警生成"""
        pass

    @abstractmethod
    def healthcheck(self) -> HealthStatus:
        """健康检查"""
        pass
```

### 4.2 标准输出格式

```json
{
    "task_id": "uuid",
    "plugin_id": "transformer_inspection",
    "plugin_version": "1.0.0",
    "code_hash": "abc123",
    "timestamp": "2024-01-01T12:00:00",
    "success": true,
    "results": [
        {
            "roi_id": "roi_001",
            "bbox": {"x": 0.1, "y": 0.2, "width": 0.3, "height": 0.4},
            "label": "正常",
            "value": null,
            "confidence": 0.95,
            "model_version": "v1.0",
            "failure_reason": null
        }
    ],
    "alarms": [],
    "processing_time_ms": 150
}
```

## 5. 五大功能模块分工

| 模块 | 负责组 | 核心功能 | ROI类型 | 输出类型 |
|------|--------|----------|---------|----------|
| 主变巡视 | A组 | 外观缺陷、状态识别、热成像 | 套管/散热器/油位计/呼吸器 | 缺陷/状态/温度 |
| 开关间隔 | B组 | 分合位识别、逻辑校验、清晰度评价 | 断路器/隔离开关/接地开关 | 分/合/中间态 |
| 母线巡视 | C组 | 远距小目标、多目标并发、环境过滤 | 绝缘子/金具/导线连接点 | 缺陷+原因码 |
| 电容器 | D组 | 结构完整性、区域入侵 | 电容器组/连接线/围栏 | 倾斜/缺失/入侵 |
| 表计读数 | E组 | 任意角度读数、自动量程、失败兜底 | 各类表计 | 读数值+关键点 |

## 6. 验收标准

每个插件必须通过:

1. **可运行**: 按平台接口接入即跑（不得手改路径）
2. **可回放**: 给定回放数据,结果可复现
3. **可解释**: 输出 bbox/关键点/置信度/失败原因码
4. **可追溯**: 输出 model_version + code_hash
5. **可维护**: README + 配置样例 + 最小单测
