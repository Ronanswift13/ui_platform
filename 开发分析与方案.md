# 输变电激光星芒破夜绘明监测平台 - 开发分析与方案

## 一、现状诊断

### 1.1 项目当前状态

| 文件 | 大小 | 状态 |
|------|------|------|
| `README.md` | 5.5K | ✅ 规划文档已完成 |
| `run.py` | 2.5K | ⚠️ 启动脚本框架（依赖缺失） |

**关键问题**：`run.py` 依赖 `platform_core`、`apps` 等模块，但这些模块**尚未实现**。

### 1.2 规划书 vs 现状对比

| 规划书要求 | 当前状态 | 差距 |
|-----------|---------|------|
| **UI层** - 点位管理、ROI编辑、告警面板 | ❌ 未实现 | 需完整开发 |
| **任务层** - 任务调度、PTZ控制 | ❌ 未实现 | 需完整开发 |
| **算法层** - 5大插件模块 | ❌ 未实现 | 需框架+占位实现 |
| **设备适配层** - 摄像头/云台/热成像 | ❌ 未实现 | 需完整开发 |
| **数据层** - 配置库/结果库/证据库 | ❌ 未实现 | 需完整开发 |
| **插件接口** - init/infer/postprocess/healthcheck | ❌ 未实现 | 需定义基类 |
| **统一输出格式** - JSON标准 | ❌ 未实现 | 需Pydantic模型 |
| **证据链** - 原图/ROI/结果/时间戳 | ❌ 未实现 | 需完整开发 |

---

## 二、开发路线图

### 阶段概览

```
阶段一 (1-2周)          阶段二 (1周)           阶段三 (1-2周)        阶段四 (滚动)
┌────────────────┐    ┌────────────────┐    ┌────────────────┐    ┌────────────────┐
│  平台核心骨架   │ → │   插件框架      │ → │  证据链与调度   │ → │  业务模块接入   │
│                │    │                │    │                │    │                │
│ • logging      │    │ • BasePlugin   │    │ • evidence/    │    │ • A组主变      │
│ • schema/      │    │ • manifest解析  │    │ • scheduler/   │    │ • B组开关      │
│ • config.py    │    │ • 动态加载     │    │ • replay/      │    │ • C组母线      │
│ • exceptions   │    │ • demo插件     │    │ • 任务引擎     │    │ • D组电容器    │
│ • apps/        │    │                │    │                │    │ • E组表计      │
│ • ui/          │    │                │    │                │    │                │
└────────────────┘    └────────────────┘    └────────────────┘    └────────────────┘
     ↓                      ↓                     ↓                     ↓
  run.py可启动          插件可加载            任务可调度            功能可验收
```

---

## 三、阶段一详细方案（核心骨架）

### 3.1 目录结构创建

```
破夜绘明激光监测平台/
├── apps/                           # 应用入口层
│   ├── __init__.py
│   ├── main.py                     # 主程序入口
│   ├── api_server.py               # REST API 服务器
│   └── ui_server.py                # Web UI 服务器
│
├── platform_core/                  # 平台核心层
│   ├── __init__.py
│   ├── config.py                   # 配置中心
│   ├── exceptions.py               # 统一异常
│   ├── logging/                    # 统一日志
│   │   └── __init__.py
│   ├── schema/                     # 数据模型
│   │   ├── __init__.py
│   │   ├── models.py
│   │   └── validator.py
│   ├── plugin_manager/             # 插件管理（阶段二完善）
│   │   ├── __init__.py
│   │   ├── base.py
│   │   ├── manager.py
│   │   └── registry.py
│   ├── scheduler/                  # 任务调度（阶段三完善）
│   ├── evidence/                   # 证据链（阶段三完善）
│   ├── replay/                     # 回放功能（阶段三完善）
│   └── device_adapter/             # 设备适配
│
├── plugins/                        # 插件目录
│   ├── transformer_inspection/     # A组: 主变
│   ├── switch_inspection/          # B组: 开关
│   ├── busbar_inspection/          # C组: 母线
│   ├── capacitor_inspection/       # D组: 电容器
│   └── meter_reading/              # E组: 表计
│
├── configs/                        # 配置文件
│   ├── platform.yaml
│   └── sites/
│
├── ui/                             # Web UI
│   ├── templates/
│   │   ├── base.html
│   │   ├── index.html
│   │   └── pages/
│   └── static/
│       ├── css/
│       └── js/
│
├── tests/                          # 测试
├── docs/                           # 文档
├── evidence/                       # 证据存储
├── logs/                           # 日志
│
├── run.py                          # 快速启动（已有）
├── requirements.txt                # 依赖列表
└── README.md                       # 项目说明（已有）
```

### 3.2 核心模块实现清单

| 优先级 | 模块 | 文件 | 功能 |
|--------|------|------|------|
| P0 | 日志 | `platform_core/logging/__init__.py` | 基于loguru的统一日志 |
| P0 | 配置 | `platform_core/config.py` | YAML配置加载 |
| P0 | 异常 | `platform_core/exceptions.py` | 统一异常定义 |
| P0 | 模型 | `platform_core/schema/models.py` | Pydantic数据模型 |
| P0 | 校验 | `platform_core/schema/validator.py` | 插件输出校验 |
| P1 | 插件基类 | `platform_core/plugin_manager/base.py` | BasePlugin抽象类 |
| P1 | 插件管理 | `platform_core/plugin_manager/manager.py` | 插件加载/卸载 |
| P1 | API服务 | `apps/api_server.py` | FastAPI接口 |
| P1 | UI服务 | `apps/ui_server.py` | Web界面 |
| P2 | 设备适配 | `platform_core/device_adapter/` | 摄像头/云台 |

### 3.3 关键接口定义（对齐规划书）

#### 插件接口（规划书第50-61行）

```python
class BasePlugin(ABC):
    """插件基类 - 所有业务模块必须实现"""
    
    @abstractmethod
    def init(self, config: dict) -> bool:
        """初始化插件"""
        pass
    
    @abstractmethod
    def infer(self, frame: np.ndarray, rois: list[ROI], context: PluginContext) -> list[RecognitionResult]:
        """执行推理"""
        pass
    
    @abstractmethod
    def postprocess(self, results: list[RecognitionResult], rules: list[AlarmRule]) -> list[Alarm]:
        """后处理和告警生成"""
        pass
    
    @abstractmethod
    def healthcheck(self) -> HealthStatus:
        """健康检查"""
        pass
```

#### 统一输出格式（规划书第63-74行）

```python
class RecognitionResult(BaseModel):
    task_id: str
    site_id: str
    device_id: str
    component_id: str
    roi_id: str
    bbox: BoundingBox
    label: str
    value: Optional[Any] = None        # 表计读数/温度/状态
    confidence: float
    evidence: str = ""                  # 截图路径
    model_version: str = ""
    code_version: str = ""              # code hash
    timestamp: datetime
```

---

## 四、立即执行建议

### 4.1 第一步：创建基础框架（今日可完成）

执行以下命令创建目录结构：

```bash
# 在项目根目录执行
mkdir -p apps platform_core/{logging,schema,plugin_manager,scheduler,evidence,replay,device_adapter}
mkdir -p plugins/{transformer_inspection,switch_inspection,busbar_inspection,capacitor_inspection,meter_reading}
mkdir -p configs/sites ui/{templates/pages,static/{css,js}} tests/{unit,integration} docs evidence logs
```

### 4.2 第二步：实现核心模块

建议按以下顺序实现：

1. **`platform_core/logging/__init__.py`** - 让日志先跑起来
2. **`platform_core/config.py`** - 加载配置
3. **`platform_core/exceptions.py`** - 统一错误处理
4. **`platform_core/schema/models.py`** - 定义所有数据模型
5. **`platform_core/plugin_manager/base.py`** - 插件基类
6. **`apps/ui_server.py`** + **`apps/api_server.py`** - 让Web跑起来

### 4.3 第三步：验证目标

完成阶段一后，应达到：

```bash
python run.py
# 输出: 
# 2024-xx-xx | INFO | 输变电激光星芒破夜绘明监测平台
# 2024-xx-xx | INFO | 启动平台: http://127.0.0.1:8080
```

访问 http://127.0.0.1:8080 可看到基础UI界面。

---

## 五、风险对策（对齐规划书）

| 规划书风险项 | 对策 |
|-------------|------|
| 依赖地狱 | 使用 `requirements.txt` + lock固定版本 |
| 模型不可解释 | 强制 evidence 与 failure_reason 字段 |
| 逻辑散在main | 代码审查 + 目录结构强制 |
| 光照/逆光问题 | 失败兜底写进任务引擎 |

---

## 六、下一步行动

**是否需要我立即为您生成阶段一的完整代码框架？**

包括：
- ✅ 所有目录结构
- ✅ `platform_core/` 核心模块完整实现
- ✅ `apps/` 服务器代码
- ✅ `ui/` 基础模板
- ✅ `plugins/` 五大模块占位实现
- ✅ `configs/platform.yaml` 配置文件
- ✅ `requirements.txt` 依赖列表

这将使 `python run.py` 能够正常启动，并提供基础的Web界面和API接口。
